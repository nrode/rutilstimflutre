---
title: "Introduction to the Price's equation for breeders"
author: "Timoth√©e Flutre (INRAE)"
date: "`r format(Sys.time(), '%d/%m/%Y %H:%M:%S')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    number_sections: TRUE
  pdf_document:
    toc: true
    toc_depth: 4
    number_sections: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Motivation

The main goal of Price was to understand *selection* in an abstract way.
This consisted in answering the following question, "how does some property change between two sets", by distinguishing the part of total change due to selection.

- To evolutionary biologists, it helps (i) to rephrase the question as "how does some phenotype evolve between two populations", and (ii) to name the two sets "ancestral" and "descendant".

Yet, Price equation is fully general, e.g., differences between sets can occur through space rather than time; *what matters is the mapping between both sets*.
Most importantly, what is meant by the "part of total change due to selection" corresponds to *change in frequency* that arises directly from *differential contributions by ancestors*.


# Definitions and notations

**In the ancestral set:** (before selection)

- each entity has a *type*, indexed by $i$, and a *property*, noted $z_i$

- $q_i$ is the frequency of the $i$th type, where $\forall i, 0 < q_i \le 1$ and $\sum_i q_i = 1$

- population average: $\bar{z} = \sum_i q_i \, z_i$

**Fitness $w_i$:** contribution to the descendant set from type $i$ in the ancestral set

  - relative fitness: $w_i \, / \, \bar{w}$

  - average fitness: $\bar{w} = \sum_i q_i \, w_i$

  - let us assume that average fitness $\bar{w} = \sum_i q_i \, w_i$ is equal to one so that all fitnesses are normalized, hence $q'_i = w_i \, q_i$

**In the descendant set:** (after selection)

- a type-$i$ entity of the descendant set is an entity that is mapped to one, and only one, entity of type $i$ in the ancestral set, each entity of the descendant set hence has the type of the entity of the ancestral set with which it is mapped

- $q'_i$: frequency of type-$i$ entities in the descendant set, i.e., entities of the descendant set that are mapped to type-$i$ entities in the ancestral set

  - $q'_i = (w_i/\bar{w}) \, q_i$, where $\forall i, 0 \le q'_i \le 1$ and $\sum_i q'_i = 1$

- $z'_i$: average property among the type-$i$ entities of the descendant set

  - $z'_i = z_i + \Delta z_i$ where $\Delta z_i$ indicates by how much descendants can differ from their ancestor

- population average: $\bar{z}' = \sum_i q'_i \, z'_i$


# Illustration

```{r, echo=FALSE}
illustratePriceEq <- function(step=3){
  if(requireNamespace("plotrix", quietly=TRUE)){
    suppressPackageStartupMessages(library(plotrix))
    par(mar=c(0,0,0,0))
    plot(x=-10:10, y=-10:10, ylim=c(-3.5,4.5),
         type="n", xlab="", ylab="", axes=FALSE)

    ## first set:
    draw.ellipse(x=-5, y=0, a=4.7, b=3)
    text(x=-5, y=3.5, labels="first set", cex=2)

    draw.circle(x=-7, y=1.8, radius=0.8)
    text(x=-7, y=1.8, labels="1", cex=2, font=2)

    draw.circle(x=-3.5, y=1.8, radius=0.8, col="royalblue4")
    text(x=-3.5, y=1.8, labels="2", cex=2, font=2, col="white")

    draw.circle(x=-5, y=0, radius=0.8, col="royalblue2")
    text(x=-5, y=0, labels="3", cex=2, font=2, col="white")

    draw.circle(x=-7, y=-1.8, radius=0.8, col="skyblue1")
    text(x=-7, y=-1.8, labels="4", cex=2, font=2)

    draw.circle(x=-3.5, y=-1.8, radius=0.8, col="navy")
    text(x=-3.5, y=-1.8, labels="5", cex=2, font=2, col="white")

    ## second set:
    draw.ellipse(x=5, y=0, a=4.7, b=3)
    text(x=5, y=3.5, labels="second set", cex=2)
    if(step >= 2){

      draw.circle(x=3.5, y=2, radius=0.8, col="royalblue4")
      if(step >= 3){
        text(x=3.5, y=2, labels="2", cex=2, font=2, col="white")
        arrows(x0=-3.5+0.8, y0=1.8, x1=3.5-0.8, y1=2, lwd=3, col="red")
      }

      draw.circle(x=7, y=1.2, radius=0.8, col="royalblue3")
      if(step >= 3){
        text(x=7, y=1.2, labels="2", cex=2, font=2, col="white")
        arrows(x0=-3.5+0.8, y0=1.8, x1=7-0.8, y1=1.2, lwd=3, col="red")
      }

      draw.circle(x=5, y=0, radius=0.8, col="royalblue1")
      if(step >= 3){
        text(x=5, y=0, labels="3", cex=2, font=2, col="white")
        arrows(x0=-5+0.8, y0=0, x1=5-0.8, y1=0, lwd=3, col="red")
      }

      draw.circle(x=3.5, y=-1.2, radius=0.8, col="skyblue3")
      if(step >= 3){
        text(x=3.5, y=-1.2, labels="3", cex=2, font=2, col="white")
        arrows(x0=-5+0.8, y0=0, x1=3.5-0.8, y1=-1.2, lwd=3, col="red")
      }

      draw.circle(x=6, y=-2.1, radius=0.8, col="navy")
      if(step >= 3){
        text(x=6, y=-2.1, labels="5", cex=2, font=2, col="white")
        arrows(x0=-3.5+0.8, y0=-1.8, x1=6-0.8, y1=-2.1, lwd=3, col="red")
      }
    }
  }
}
```

```{r, echo=FALSE, fig.width=9, fig.height=4}
illustratePriceEq(1)
```

```{r, echo=FALSE, fig.width=9, fig.height=4}
## illustratePriceEq(2)
```

```{r, echo=FALSE, fig.width=9, fig.height=4}
illustratePriceEq(3)
```


# Derivation of Price's equation

Goal: express the total change in average property in terms of frequency change (*selection*) and property change

Here is the first, straight-forward way of deriving Price's equation:
\begin{align}
\Delta \bar{z} &= \bar{z}' - \bar{z} \\
 &= \sum_i q'_i \, z'_i \; - \; \sum_i q_i \, z_i \\
 &= \sum_i (q'_i - q_i) \, z_i \; + \; \sum_i q'_i \, z'_i \; - \; \sum_i q'_i \, z_i \\
 &= \sum_i (\Delta q_i) \, z_i \; + \; \sum_i q'_i \, (\Delta z_i)
\end{align}

But it is more commonly expressed with probabilistic notions:

- expectation of a random variable: $\text{E}(X) = \sum_i p_i X_i$ (if $X$ is discrete and $p_i = \text{Pr}[X = X_i]$)

- expectation of a product of two random variables: $\text{E}(X Y) = \text{E}(X) \text{E}(Y) + Cov(X, Y)$.

Let us reformulate the first term:

$\sum_i (\Delta q_i) \, z_i = \sum_i q_i \, (w_i - 1) \, z_i$

Considering the $w_i$'s (respectively the $z_i$'s) as outcomes of a random variable $w$ (resp., $z$) and recognizing that $\text{E}(w - 1) = 0$ leads to $\sum_i (\Delta q_i) \, z_i = Cov(w, z)$.

Similarly: $\sum_i q'_i \, (\Delta z_i) = \sum_i q_i w_i \, (\Delta z_i) = \text{E}(w \, \Delta z)$

Here is the probabilistic way of writing down Price's equation, often found in articles and textbooks:

\begin{align}
\Delta \bar{z} = Cov(w, z) \, + \, \text{E}(w \, \Delta z)
\end{align}


# Derivation of Robertson's second theorem

Let us assume that the ancestral set consists in potential parents and the descendant set consists in their offsprings.
In quantitative genetics since Fisher, the parental phenotype $z$ is classically decomposed into a transmissible part noted $g_a$ (also kown as the additive genotypic value, or *breeding* value) and a non-transmissible part noted $\epsilon$, with $z = g_a + \epsilon$ and $\text{E}(\epsilon) = 0$ so that $z' = g_a$.
As a result, Price's equation applied to this mapping expresses the response to selection, $R$:

\begin{align}
R &= \bar{z}_{\text{offsprings}} - \bar{z}_{\text{potential parents}} \\
 &= Cov(w, g_a + \epsilon) - \text{E}(w \epsilon) \\
 &= Cov(w, g_a) + Cov(w, \epsilon) - Cov(w, \epsilon) \\
 &= Cov(w, g_a)
\end{align}

It is also known as Robertson's secondary theorem.


# Derivation of the breeder's equation

What defines a breeder is the possibility to apply selection, typically by truncation, on a population of $N$ individuals.
In the framework of Price's mapping, let us define two sets, before and after selection, both made of the exact same $N$ individuals:

- before selection, each individual of the parental population is a potential parent, hence $q_i = 1/N$;

- however, after selection, only a subset of the $N$ individuals will actually become parents according to the potential breeding contribution $q'_i = q_i w_i$.

Importantly, because individuals are the same between both sets, their phenotype remains the same: $\Delta z = 0$.

As a result, Price's equation applied to this mapping expresses the selection differential:

\begin{align}
S &= \bar{z}_{\text{selected parents}} - \bar{z}_{\text{potential parents}} \\
 &= Cov(w, z)
\end{align}

A breeder is typically interested in predicting the response to selection $R$ he/she would obtain based on the selection differential $S$ he/she could apply.
In this goal, let us assume that fitness $w$ is linearly dependent on $z$ so that $w = \beta_{wz} z + \delta$ where $\beta_{wz}$ denotes the linear regression coefficient and $\text{E}(\delta) = 0$.
Replacing $z$ by its own decomposition (above) gives the following:

\begin{align}
w &= \beta_{wz} (g_a + \epsilon) + \delta \\
 &= \beta_{w g_a} g_a + \gamma
 \end{align}

where $\beta_{w g_a} := \beta_{wz}$ and $\gamma := \beta_{wz} \epsilon + \delta$.

Importantly, let us also assume that $Cov(g_a, \gamma) = 0$, which usually is reasonable for artificial selection but much less so for natural selection.

Reminder: in the simple linear regression $y_i = \mu + \beta x_i + \epsilon_i$ with $\epsilon_i \sim \mathcal{N}(0, \sigma^2)$, the maximum-likelihood estimator of $\beta$ is $B = \frac{Cov(y, x)}{Var(x)}$.

As a result:

\begin{align}
R &= Cov(w, g_a) \\
 &= \beta_{wg} Var(g_a) \\
 &= \beta_{wz} Var(g_a) \frac{Var(z)}{Var(z)} \\
 &= \frac{Var(g_a)}{Var(z)} \, Cov(w, z) \\
 &= h^2 \, S
\end{align}

This is also known as the breeder's equation where $h^2$ is called the (narrow-sense) heritability.

The breeder's equation is then often written differently to ease the comparison of selection responses between traits and to highlight the factors determining the magnitude of selection response.
Because $S$ is in the same unit of the phenotype $z$, it is often standardized by the phenotypic standard deviation, leading to the *intensity of selection*: $i = \frac{S}{\sigma_z}$.
Moreover, $h^2$ corresponds to the slope of the regression of the breeding value on the phenotype: $h^2 = \frac{Cov(g_a, z)}{Var(z)} = \frac{Cov(g_a, g_a + \epsilon)}{Var(z)} = \frac{Var(g_a)}{Var(z)}$.
This means that the square root of $h^2$ corresponds to the correlation between breeding value and phenotype: $h = \frac{\sigma_{g_a}}{\sigma_z} = \frac{Var(g_a)}{\sigma_{g_a} \sigma_z} = \frac{Cov(g_a, z)}{\sigma_{g_a} \sigma_z} = Cor(g_a,z)$.

As a result:

\begin{align}
R &= i \, h^2 \, \sigma_z \\
 &= i \, h \, \sigma_{g_a} \\
 &= i \, Cor(g_a,z) \, \sigma_{g_a}
\end{align}

This formula corresponds to the case where a breeder performs phenotypic selection, i.e., the selection is made using phenotypic observations, hence what counts is the accuracy with which phenotypic observations ($z$) inform about breeding values ($g_a$).
More generally, a breeder applies its selection on estimated breeding values (EBVs):

\[
R = i \, \rho \, \sigma_{g_a}
\]

where $\rho$ is the correlation between the estimated and the true breeding values.



# References

- Price G. 1970. Selection and covariance. Nature. 227(5257):520‚Äì521. doi:10.1038/227520a0.

- Price G. 1972. Extension of covariance selection mathematics. Annals of Human Genetics. 35(4):485‚Äì490. doi:10.1111/j.1469-1809.1957.tb01874.x.

- Price G. 1995. The nature of selection. Journal of Theoretical Biology. 175(3):389‚Äì396. doi:10.1006/jtbi.1995.0149.

- Fisher R. 1918. The correlation between relatives on the supposition of Mendelian inheritance. Transactions of the Royal Society Edinburgh. 52(2):399‚Äì433. doi:10.1017/S0080456800012163.

- Lush JL. 1937. Animal breeding plans. Ames: Iowa State University Press.

- Robertson A. 1966. A mathematical model of the culling process in dairy cattle. Animal Science. 8(1):95‚Äì108. doi:10.1017/S0003356100037752.

- Frank S. 1995. George Price‚Äôs contributions to evolutionary genetics. Journal of Theoretical Biology. 175(3):373‚Äì388. doi:10.1006/jtbi.1995.0148.

- Frank SA. 1997. The Price Equation, Fisher‚Äôs Fundamental Theorem, Kin Selection, and Causal Analysis. Evolution. 51(6):1712‚Äì1729. doi:10.2307/2410995.

- Frank SA. 2012. Natural selection. IV. The Price equation. Journal of Evolutionary Biology. 25(6):1002‚Äì1019. doi:10.1111/j.1420-9101.2012.02498.x.

- Queller DC. 2017. Fundamental Theorems of Evolution. The American Naturalist. 189(4). doi:10.1086/690937.

- Bijma P. 2020. The Price equation as a bridge between animal breeding and evolutionary biology. Phil Trans R Soc B. 375(1797):20190360. doi:10.1098/rstb.2019.0360.

- Gardner A. 2020. Price‚Äôs equation made clear. Phil Trans R Soc B. 375(1797):20190361. doi:10.1098/rstb.2019.0361.
